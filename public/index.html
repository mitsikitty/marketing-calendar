<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketing Calendar</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg:#f3f4f6; --surface:#fff; --surface2:#f8f9fb; --border:#e5e7eb;
  --text:#1f2937; --text-muted:#6b7280; --text-light:#9ca3af;
  --shadow:rgba(0,0,0,0.07); --radius:4px; --topbar-h:48px;
  --campaigns:#7c3aed; --campaigns-bg:#ede9fe; --campaigns-text:#5b21b6;
  --content:#0891b2;   --content-bg:#e0f2fe;   --content-text:#0369a1;
  --alwayson:#059669;  --alwayson-bg:#d1fae5;  --alwayson-text:#065f46;
  --paid:#d97706;      --paid-bg:#fef3c7;      --paid-text:#92400e;
  --holidays:#db2777;  --holidays-bg:#fce7f3;  --holidays-text:#9d174d;
}
[data-dark] {
  --bg:#1a1d27; --surface:#22263a; --surface2:#2a2f45;
  --border:rgba(255,255,255,0.09); --text:#e5e7eb; --text-muted:#9ca3af; --text-light:#4b5563;
  --shadow:rgba(0,0,0,0.35);
  --campaigns-bg:rgba(124,58,237,0.2); --campaigns-text:#c4b5fd;
  --content-bg:rgba(8,145,178,0.2);    --content-text:#67e8f9;
  --alwayson-bg:rgba(5,150,105,0.2);   --alwayson-text:#6ee7b7;
  --paid-bg:rgba(217,119,6,0.2);       --paid-text:#fcd34d;
  --holidays-bg:rgba(219,39,119,0.2);  --holidays-text:#f9a8d4;
}

html, body { height:100%; overflow:hidden; }

body {
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--bg); color:var(--text); font-size:13px;
  display:flex; flex-direction:column;
}

/* ── Topbar ── */
.topbar {
  height:var(--topbar-h); min-height:var(--topbar-h);
  background:var(--surface); border-bottom:1px solid var(--border);
  padding:0 14px; display:flex; align-items:center; gap:10px;
  flex-wrap:nowrap; overflow-x:auto; flex-shrink:0;
  box-shadow:0 1px 3px var(--shadow); z-index:20;
}
.topbar-left { display:flex; align-items:center; gap:6px; flex-shrink:0; }
.btn {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  cursor:pointer; padding:4px 9px; border-radius:var(--radius);
  font-size:12px; font-family:inherit; transition:all .12s; white-space:nowrap; line-height:1.5;
}
.btn:hover { background:var(--surface2); color:var(--text); }
.btn-icon { padding:4px 8px; font-size:13px; }
.btn-primary { background:#7c3aed; color:#fff; border-color:transparent; font-weight:500; }
.btn-primary:hover { background:#6d28d9; color:#fff; }
.month-label { font-size:15px; font-weight:600; color:var(--text); padding:0 4px; white-space:nowrap; }
.status-dot { width:7px; height:7px; border-radius:50%; background:#10b981; flex-shrink:0; cursor:default; }
.status-dot.loading { background:#f59e0b; animation:blink .7s infinite; }
.status-dot.error   { background:#ef4444; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:.25} }
.topbar-sep { width:1px; height:18px; background:var(--border); flex-shrink:0; }
.layers { display:flex; align-items:center; gap:5px; flex-shrink:0; }
.layers-label { font-size:10px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.06em; white-space:nowrap; }
.layer-toggle {
  display:flex; align-items:center; gap:4px; padding:3px 8px;
  border-radius:20px; border:1.5px solid transparent; cursor:pointer;
  font-size:11px; font-weight:500; font-family:inherit; transition:all .12s; user-select:none; white-space:nowrap;
}
.layer-toggle .dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.layer-toggle[data-layer="campaigns"]{ background:var(--campaigns-bg); color:var(--campaigns-text); border-color:var(--campaigns); }
.layer-toggle[data-layer="campaigns"] .dot { background:var(--campaigns); }
.layer-toggle[data-layer="content"]  { background:var(--content-bg);   color:var(--content-text);   border-color:var(--content); }
.layer-toggle[data-layer="content"]  .dot { background:var(--content); }
.layer-toggle[data-layer="alwayson"] { background:var(--alwayson-bg);  color:var(--alwayson-text);  border-color:var(--alwayson); }
.layer-toggle[data-layer="alwayson"] .dot { background:var(--alwayson); }
.layer-toggle[data-layer="paid"]     { background:var(--paid-bg);      color:var(--paid-text);      border-color:var(--paid); }
.layer-toggle[data-layer="paid"]     .dot { background:var(--paid); }
.layer-toggle[data-layer="holidays"] { background:var(--holidays-bg);  color:var(--holidays-text);  border-color:var(--holidays); }
.layer-toggle[data-layer="holidays"] .dot { background:var(--holidays); }
.layer-toggle.off { background:transparent!important; color:var(--text-muted)!important; border-color:var(--border)!important; }
.layer-toggle.off .dot { background:var(--text-light)!important; }

/* ── Main area: calendar + slide panel ── */
.main {
  flex:1; display:flex; overflow:hidden; position:relative;
}

/* ── Calendar ── */
.cal-wrap {
  flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0;
  transition: margin-right .25s ease;
}
.cal-header {
  display:grid; grid-template-columns:repeat(7,1fr);
  background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0;
}
.cal-header-day {
  padding:6px 8px; font-size:11px; font-weight:600; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.05em;
  border-right:1px solid var(--border);
}
.cal-header-day:last-child { border-right:none; }

.cal-grid {
  flex:1; display:grid; grid-template-columns:repeat(7,1fr);
  grid-auto-rows:minmax(0,1fr); overflow-y:auto;
}

.cal-cell {
  background:var(--surface); border-right:1px solid var(--border);
  border-bottom:1px solid var(--border); padding:4px;
  cursor:pointer; transition:background .1s; overflow:hidden;
  display:flex; flex-direction:column;
  min-height:90px;
}
.cal-cell:nth-child(7n) { border-right:none; }
.cal-cell:hover { background:var(--surface2); }
.cal-cell.other-month { background:var(--bg); }
.cal-cell.other-month .day-num { color:var(--text-light); }
.day-num {
  font-size:12px; font-weight:500; color:var(--text-muted);
  width:22px; height:22px; border-radius:50%; display:flex;
  align-items:center; justify-content:center; flex-shrink:0; margin-bottom:2px;
}
.cal-cell.today .day-num { background:#7c3aed; color:#fff; font-weight:700; }

/* ── Events ── */
.event {
  display:block; border-radius:3px; padding:2px 5px; margin-bottom:2px;
  cursor:pointer; overflow:hidden; text-decoration:none; border-left:3px solid transparent;
  transition:filter .1s; flex-shrink:0;
}
.event:hover { filter:brightness(.93); }
.event-title {
  font-size:10.5px; font-weight:500; white-space:nowrap;
  overflow:hidden; text-overflow:ellipsis; line-height:1.4;
}
.event-pills { display:flex; gap:2px; flex-wrap:wrap; margin-top:2px; }
.pill {
  font-size:9px; font-weight:700; padding:1px 4px; border-radius:3px;
  white-space:nowrap; line-height:1.5; letter-spacing:.01em;
}
.pill-tiktok    { background:#010101; color:#fff; }
.pill-reel      { background:#e1306c; color:#fff; }
.pill-carousel  { background:#7c3aed; color:#fff; }
.pill-stories   { background:#fd7e14; color:#fff; }
.pill-image     { background:#405de6; color:#fff; }
.pill-fbpost    { background:#1877f2; color:#fff; }
.pill-edm       { background:#f59e0b; color:#111; }
.pill-blog      { background:#6b7280; color:#fff; }
.pill-metaads   { background:#0668E1; color:#fff; }
.pill-googleads { background:#34a853; color:#fff; }
.pill-generic   { background:#e5e7eb; color:#374151; }
.pill-tkt  { background:#010101; color:#fff; }
.pill-yt   { background:#ff0000; color:#fff; }
.pill-igfb { background:linear-gradient(135deg,#833ab4,#e1306c); color:#fff; }
.pill-igt  { background:#c13584; color:#fff; }
.pill-paidloc { background:#0668E1; color:#fff; }
.pill-web  { background:#10b981; color:#fff; }
.pill-email{ background:#6b7280; color:#fff; }

.event.campaigns { background:var(--campaigns-bg); border-left-color:var(--campaigns); }
.event.campaigns .event-title { color:var(--campaigns-text); }
.event.content   { background:var(--content-bg);   border-left-color:var(--content); }
.event.content   .event-title { color:var(--content-text); }
.event.alwayson  { background:var(--alwayson-bg);  border-left-color:var(--alwayson); }
.event.alwayson  .event-title { color:var(--alwayson-text); }
.event.paid      { background:var(--paid-bg);      border-left-color:var(--paid); }
.event.paid      .event-title { color:var(--paid-text); }
.event.holidays  { background:var(--holidays-bg);  border-left-color:var(--holidays); }
.event.holidays  .event-title { color:var(--holidays-text); }
.event.span-mid, .event.span-end { border-left:none; opacity:.65; }
.event.span-mid .event-title, .event.span-end .event-title { visibility:hidden; font-size:1px; }
.event.span-mid .event-pills, .event.span-end .event-pills { display:none; }
.event[data-layer].hidden { display:none!important; }

/* ── Slide-in task panel ── */
.task-panel {
  width: 420px; flex-shrink:0;
  background:var(--surface); border-left:1px solid var(--border);
  display:flex; flex-direction:column;
  transform:translateX(100%); transition:transform .25s ease;
  position:absolute; right:0; top:0; bottom:0; z-index:15;
  box-shadow:-4px 0 16px var(--shadow);
}
.task-panel.open { transform:translateX(0); }

.panel-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid var(--border); flex-shrink:0;
}
.panel-title { font-size:13px; font-weight:600; color:var(--text); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.panel-actions { display:flex; gap:6px; flex-shrink:0; }
.panel-close { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; line-height:1; }
.panel-close:hover { background:var(--surface2); }

.panel-iframe-wrap { flex:1; overflow:hidden; }
.panel-iframe-wrap iframe {
  width:100%; height:100%; border:none;
  background:var(--surface);
}

.panel-loading {
  display:flex; align-items:center; justify-content:center;
  height:100%; color:var(--text-muted); font-size:12px; flex-direction:column; gap:8px;
}
.panel-spinner {
  width:24px; height:24px; border:2px solid var(--border);
  border-top-color:#7c3aed; border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* ── Create task modal ── */
.overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:100;
  display:flex; align-items:center; justify-content:center; padding:16px;
  opacity:0; pointer-events:none; transition:opacity .15s;
}
.overlay.open { opacity:1; pointer-events:all; }
.modal {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:20px; width:100%; max-width:400px;
  box-shadow:0 20px 60px rgba(0,0,0,0.15);
  transform:translateY(10px); transition:transform .15s;
}
.overlay.open .modal { transform:translateY(0); }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.modal-title  { font-size:14px; font-weight:600; }
.modal-close-btn { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; line-height:1; }
.modal-close-btn:hover { background:var(--surface2); }
.field { margin-bottom:11px; }
.field label { display:block; font-size:11px; font-weight:500; color:var(--text-muted); margin-bottom:4px; text-transform:uppercase; letter-spacing:.04em; }
.field input, .field select {
  width:100%; padding:7px 10px; border:1px solid var(--border); border-radius:var(--radius);
  background:var(--surface); color:var(--text); font-size:13px; font-family:inherit; outline:none;
}
.field input:focus, .field select:focus { border-color:#7c3aed; box-shadow:0 0 0 2px rgba(124,58,237,0.12); }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; padding-top:14px; border-top:1px solid var(--border); }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-left">
    <button class="btn btn-icon" id="prevBtn">&#8249;</button>
    <button class="btn" onclick="goToday()">Today</button>
    <button class="btn btn-icon" id="nextBtn">&#8250;</button>
    <span class="month-label" id="monthLabel"></span>
    <span class="status-dot" id="statusDot" title="Data status"></span>
    <button class="btn" onclick="loadTasks()" style="font-size:11px;padding:3px 8px">↻</button>
    <button class="btn btn-icon" id="themeBtn" title="Toggle theme">☾</button>
  </div>
  <div class="topbar-sep"></div>
  <div class="layers">
    <span class="layers-label">Lists</span>
    <button class="layer-toggle" data-layer="campaigns"><span class="dot"></span>Campaigns</button>
    <button class="layer-toggle" data-layer="content"><span class="dot"></span>Content</button>
    <button class="layer-toggle" data-layer="alwayson"><span class="dot"></span>Always On</button>
    <button class="layer-toggle" data-layer="paid"><span class="dot"></span>Paid Ads</button>
    <button class="layer-toggle" data-layer="holidays"><span class="dot"></span>Holidays</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="cal-wrap" id="calWrap">
    <div class="cal-header">
      <div class="cal-header-day">Mon</div><div class="cal-header-day">Tue</div>
      <div class="cal-header-day">Wed</div><div class="cal-header-day">Thu</div>
      <div class="cal-header-day">Fri</div><div class="cal-header-day">Sat</div>
      <div class="cal-header-day">Sun</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>

  <!-- Slide-in task panel -->
  <div class="task-panel" id="taskPanel">
    <div class="panel-header">
      <span class="panel-title" id="panelTitle">Task</span>
      <div class="panel-actions">
        <a class="btn btn-icon" id="panelOpenLink" href="#" target="_blank" title="Open in new tab" style="text-decoration:none;font-size:11px">↗ Open</a>
        <button class="panel-close" onclick="closePanel()">×</button>
      </div>
    </div>
    <div class="panel-iframe-wrap" id="panelContent">
      <div class="panel-loading">
        <div class="panel-spinner"></div>
        <span>Loading task…</span>
      </div>
    </div>
  </div>
</div>

<!-- Create task modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Task</span>
      <button class="modal-close-btn" onclick="closeModal()">×</button>
    </div>
    <div class="field">
      <label>Title</label>
      <input type="text" id="f-title" placeholder="Task name…" />
    </div>
    <div class="field">
      <label>List</label>
      <select id="f-layer">
        <option value="content">Campaign Content</option>
        <option value="campaigns">Campaigns</option>
        <option value="alwayson">Always On</option>
        <option value="paid">Paid Ads</option>
        <option value="holidays">Holidays & Events</option>
      </select>
    </div>
    <div class="field-row">
      <div class="field"><label>Start Date</label><input type="date" id="f-start" /></div>
      <div class="field"><label>Due / End Date</label><input type="date" id="f-end" /></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="createBtn" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<script>
const API = "/api/clickup";
let tasks = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
const layerVis = { campaigns:true, content:true, alwayson:true, paid:true, holidays:true };

// ── Theme ──
let forceDark = null;
const themeBtn = document.getElementById("themeBtn");
function isDark() { return forceDark !== null ? forceDark : window.matchMedia("(prefers-color-scheme:dark)").matches; }
function applyTheme() {
  isDark() ? document.documentElement.setAttribute("data-dark","") : document.documentElement.removeAttribute("data-dark");
  themeBtn.textContent = isDark() ? "☀︎" : "☾";
}
themeBtn.addEventListener("click", () => { forceDark = !isDark(); applyTheme(); });
window.matchMedia("(prefers-color-scheme:dark)").addEventListener("change", () => { if(forceDark===null) applyTheme(); });
applyTheme();

// ── Pill helpers ──
function typePillClass(t) {
  const m = { TikTok:"pill-tiktok", Reel:"pill-reel", Carousel:"pill-carousel",
    Stories:"pill-stories", Image:"pill-image", "FB Post":"pill-fbpost",
    EDM:"pill-edm", Blog:"pill-blog", "Meta Ads":"pill-metaads", "Google Ads":"pill-googleads" };
  return m[t] || "pill-generic";
}
function locPillClass(l) {
  const m = { TikTok:"pill-tkt", YouTube:"pill-yt", "IG/FB":"pill-igfb",
    "IG Trial":"pill-igt", "Paid Ad":"pill-paidloc", Website:"pill-web", Email:"pill-email" };
  return m[l] || "pill-generic";
}

// ── Load tasks ──
async function loadTasks() {
  const dot = document.getElementById("statusDot");
  dot.className = "status-dot loading";
  try {
    const res = await fetch(`${API}?action=tasks`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    tasks = await res.json();
    dot.className = "status-dot";
    dot.title = `Refreshed ${new Date().toLocaleTimeString("en-AU")}`;
    render();
  } catch(e) {
    dot.className = "status-dot error";
    dot.title = "Error: " + e.message;
    console.error(e);
  }
}

// ── Date helpers ──
function parseDate(s) { if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function isSameDay(a,b) { return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
function fmtDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

// ── Render ──
function render() {
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  document.getElementById("monthLabel").textContent = `${months[currentMonth]} ${currentYear}`;
  const grid = document.getElementById("calGrid");
  grid.innerHTML = "";
  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const startOffset = (firstDay.getDay()+6)%7;
  const daysInMonth = new Date(currentYear,currentMonth+1,0).getDate();
  const prevDays = new Date(currentYear,currentMonth,0).getDate();

  const cells = [];
  for(let i=startOffset-1;i>=0;i--) cells.push({date:new Date(currentYear,currentMonth-1,prevDays-i),other:true});
  for(let d=1;d<=daysInMonth;d++) cells.push({date:new Date(currentYear,currentMonth,d),other:false});
  const rem=(7-(cells.length%7))%7;
  for(let d=1;d<=rem;d++) cells.push({date:new Date(currentYear,currentMonth+1,d),other:true});

  cells.forEach(cell => {
    const div = document.createElement("div");
    div.className = "cal-cell"+(cell.other?" other-month":"")+(isSameDay(cell.date,today)?" today":"");

    const numDiv = document.createElement("div");
    numDiv.className = "day-num";
    numDiv.textContent = cell.date.getDate();
    div.appendChild(numDiv);

    // Click blank cell → create task
    div.addEventListener("click", e => {
      if(e.target===div||e.target===numDiv) openModal(cell.date);
    });

    // Tasks for this cell
    const dayTasks = tasks.filter(t => {
      const s = parseDate(t.start), e = parseDate(t.end) || parseDate(t.start);
      if(!s&&!e) return false;
      return cell.date >= (s||e) && cell.date <= (e||s);
    });

    dayTasks.forEach(t => {
      const s = parseDate(t.start), e = parseDate(t.end) || parseDate(t.start);
      const isStart = isSameDay(cell.date, s||e);
      const isEnd   = isSameDay(cell.date, e||s);
      const isSpan  = s && e && !isSameDay(s,e);
      let spanClass = "";
      if(isSpan) { spanClass = isStart ? "span-start" : isEnd ? "span-end" : "span-mid"; }

      const evDiv = document.createElement("div");
      evDiv.className = `event ${t.layer} ${spanClass}`;
      evDiv.setAttribute("data-layer", t.layer);
      if(!layerVis[t.layer]) evDiv.classList.add("hidden");

      // Click task → open slide panel
      evDiv.addEventListener("click", e => { e.stopPropagation(); openPanel(t); });

      if(!isSpan || isStart) {
        const titleDiv = document.createElement("div");
        titleDiv.className = "event-title";
        titleDiv.textContent = t.title;
        evDiv.appendChild(titleDiv);

        // Pills: content type + publish locations
        const showType = t.type && !["Campaign","Always On","Selling Season"].includes(t.type);
        if(showType || (t.locations && t.locations.length)) {
          const pillsDiv = document.createElement("div");
          pillsDiv.className = "event-pills";
          if(showType) {
            const p = document.createElement("span");
            p.className = `pill ${typePillClass(t.type)}`;
            p.textContent = t.type;
            pillsDiv.appendChild(p);
          }
          (t.locations||[]).forEach(l => {
            const p = document.createElement("span");
            p.className = `pill ${locPillClass(l)}`;
            p.textContent = l;
            pillsDiv.appendChild(p);
          });
          if(pillsDiv.children.length) evDiv.appendChild(pillsDiv);
        }
      } else {
        evDiv.innerHTML = "&nbsp;";
      }

      div.appendChild(evDiv);
    });

    grid.appendChild(div);
  });
}

// ── Slide panel ──
function openPanel(task) {
  const panel = document.getElementById("taskPanel");
  const content = document.getElementById("panelContent");
  const titleEl = document.getElementById("panelTitle");
  const linkBtn = document.getElementById("panelOpenLink");

  titleEl.textContent = task.title;
  linkBtn.href = task.url || "#";

  // Show spinner then load iframe
  content.innerHTML = `<div class="panel-loading"><div class="panel-spinner"></div><span>Loading…</span></div>`;

  // ClickUp blocks iframe embedding (X-Frame-Options: DENY) and crashes when framed.
  // Always show the detail card; the "↗ Open" button links directly to ClickUp.
  showPanelFallback(task);

  panel.classList.add("open");
}

function showPanelFallback(task) {
  // ClickUp may block iframe embedding — show a clean detail card instead
  const content = document.getElementById("panelContent");
  const pub = task.publishDate ? new Date(task.publishDate).toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"}) : "—";
  const start = task.start ? new Date(task.start).toLocaleDateString("en-AU",{day:"numeric",month:"short"}) : "—";
  const end = task.end ? new Date(task.end).toLocaleDateString("en-AU",{day:"numeric",month:"short"}) : "—";

  content.innerHTML = `
    <div style="padding:16px;overflow-y:auto;height:100%">
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Status</div>
        <div style="display:inline-block;padding:2px 8px;border-radius:4px;background:var(--surface2);font-size:12px;font-weight:500;text-transform:capitalize">${task.status||"—"}</div>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">List</div>
        <div style="font-size:13px">${task.layer}</div>
      </div>
      ${task.type?`<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Content Type</div><div style="font-size:13px">${task.type}</div></div>`:""}
      ${task.locations&&task.locations.length?`<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Publish Locations</div><div style="display:flex;gap:4px;flex-wrap:wrap">${task.locations.map(l=>`<span class="pill ${locPillClass(l)}">${l}</span>`).join("")}</div></div>`:""}
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Publish Date</div>
        <div style="font-size:13px">${pub}</div>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Campaign Dates</div>
        <div style="font-size:13px">${start} → ${end}</div>
      </div>
      ${task.assignees&&task.assignees.length?`<div style="margin-bottom:14px"><div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">Assignees</div><div style="font-size:13px">${task.assignees.map(a=>a.name).join(", ")}</div></div>`:""}
      <div style="margin-top:20px;padding-top:14px;border-top:1px solid var(--border)">
        <a href="${task.url}" target="_blank" class="btn btn-primary" style="display:inline-block;text-decoration:none;font-size:12px">↗ Open in ClickUp</a>
      </div>
    </div>`;
}

function closePanel() {
  document.getElementById("taskPanel").classList.remove("open");
}

// Close panel on Escape
document.addEventListener("keydown", e => {
  if(e.key === "Escape") { closeModal(); closePanel(); }
});

// ── Create task modal ──
function openModal(date) {
  const d = fmtDate(date);
  document.getElementById("f-start").value = d;
  document.getElementById("f-end").value = d;
  document.getElementById("f-title").value = "";
  document.getElementById("overlay").classList.add("open");
  setTimeout(() => document.getElementById("f-title").focus(), 120);
}
function closeModal() { document.getElementById("overlay").classList.remove("open"); }
document.getElementById("overlay").addEventListener("click", e => { if(e.target.id==="overlay") closeModal(); });

async function createTask() {
  const title = document.getElementById("f-title").value.trim();
  if(!title) { document.getElementById("f-title").focus(); return; }
  const btn = document.getElementById("createBtn");
  btn.textContent = "Creating…"; btn.disabled = true;
  try {
    const res = await fetch(`${API}?action=create`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        title,
        layer: document.getElementById("f-layer").value,
        start: document.getElementById("f-start").value,
        end:   document.getElementById("f-end").value,
      })
    });
    const data = await res.json();
    closeModal();
    await loadTasks();
    // Open new task in panel
    if(data.url) {
      const newTask = tasks.find(t => t.id === data.id) || { id:data.id, title, url:data.url, layer:document.getElementById("f-layer").value };
      openPanel(newTask);
    }
  } catch(e) {
    alert("Error creating task: " + e.message);
  } finally {
    btn.textContent = "Create Task"; btn.disabled = false;
  }
}

// ── Nav ──
document.getElementById("prevBtn").addEventListener("click", () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} render(); });
document.getElementById("nextBtn").addEventListener("click", () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} render(); });
function goToday() { const n=new Date(); currentYear=n.getFullYear(); currentMonth=n.getMonth(); render(); }

// ── Layer toggles ──
document.querySelectorAll(".layer-toggle").forEach(btn => {
  btn.addEventListener("click", () => {
    const l = btn.dataset.layer;
    layerVis[l] = !layerVis[l];
    btn.classList.toggle("off", !layerVis[l]);
    document.querySelectorAll(`.event[data-layer="${l}"]`).forEach(ev => ev.classList.toggle("hidden", !layerVis[l]));
  });
});

// ── Init ──
loadTasks();
setInterval(loadTasks, 10*60*1000);
</script>
</body>
</html>
