<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marketing Calendar</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg:#f3f4f6; --surface:#fff; --surface2:#f8f9fb; --border:#e5e7eb;
  --text:#1f2937; --text-muted:#6b7280; --text-light:#9ca3af;
  --shadow:rgba(0,0,0,0.07); --radius:4px; --topbar-h:48px;
  --campaigns:#7c3aed; --campaigns-bg:#ede9fe; --campaigns-text:#5b21b6;
  --content:#0891b2;   --content-bg:#e0f2fe;   --content-text:#0369a1;
  --alwayson:#059669;  --alwayson-bg:#d1fae5;  --alwayson-text:#065f46;
  --paid:#d97706;      --paid-bg:#fef3c7;      --paid-text:#92400e;
  --holidays:#db2777;  --holidays-bg:#fce7f3;  --holidays-text:#9d174d;
}
[data-dark] {
  --bg:#1a1d27; --surface:#22263a; --surface2:#2a2f45;
  --border:rgba(255,255,255,0.09); --text:#e5e7eb; --text-muted:#9ca3af; --text-light:#4b5563;
  --shadow:rgba(0,0,0,0.35);
  --campaigns-bg:rgba(124,58,237,0.2); --campaigns-text:#c4b5fd;
  --content-bg:rgba(8,145,178,0.2);    --content-text:#67e8f9;
  --alwayson-bg:rgba(5,150,105,0.2);   --alwayson-text:#6ee7b7;
  --paid-bg:rgba(217,119,6,0.2);       --paid-text:#fcd34d;
  --holidays-bg:rgba(219,39,119,0.2);  --holidays-text:#f9a8d4;
}

html, body { height:100%; overflow:hidden; }

body {
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
  background:var(--bg); color:var(--text); font-size:13px;
  display:flex; flex-direction:column;
}

/* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
.topbar {
  height:var(--topbar-h); min-height:var(--topbar-h);
  background:var(--surface); border-bottom:1px solid var(--border);
  padding:0 14px; display:flex; align-items:center; gap:10px;
  flex-wrap:nowrap; overflow-x:auto; flex-shrink:0;
  box-shadow:0 1px 3px var(--shadow); z-index:20;
}
.topbar-left { display:flex; align-items:center; gap:6px; flex-shrink:0; }
.btn {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  cursor:pointer; padding:4px 9px; border-radius:var(--radius);
  font-size:12px; font-family:inherit; transition:all .12s; white-space:nowrap; line-height:1.5;
}
.btn:hover { background:var(--surface2); color:var(--text); }
.btn-icon { padding:4px 8px; font-size:13px; }
.btn-primary { background:#7c3aed; color:#fff; border-color:transparent; font-weight:500; }
.btn-primary:hover { background:#6d28d9; color:#fff; }
.month-label { font-size:15px; font-weight:600; color:var(--text); padding:0 4px; white-space:nowrap; }
.status-dot { width:7px; height:7px; border-radius:50%; background:#10b981; flex-shrink:0; cursor:default; }
.status-dot.loading { background:#f59e0b; animation:blink .7s infinite; }
.status-dot.error   { background:#ef4444; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:.25} }
.topbar-sep { width:1px; height:18px; background:var(--border); flex-shrink:0; }
.layers { display:flex; align-items:center; gap:5px; flex-shrink:0; }
.layers-label { font-size:10px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.06em; white-space:nowrap; }
.layer-toggle {
  display:flex; align-items:center; gap:4px; padding:3px 8px;
  border-radius:20px; border:1.5px solid transparent; cursor:pointer;
  font-size:11px; font-weight:500; font-family:inherit; transition:all .12s; user-select:none; white-space:nowrap;
}
.layer-toggle .dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.layer-toggle[data-layer="campaigns"]{ background:var(--campaigns-bg); color:var(--campaigns-text); border-color:var(--campaigns); }
.layer-toggle[data-layer="campaigns"] .dot { background:var(--campaigns); }
.layer-toggle[data-layer="content"]  { background:var(--content-bg);   color:var(--content-text);   border-color:var(--content); }
.layer-toggle[data-layer="content"]  .dot { background:var(--content); }
.layer-toggle[data-layer="alwayson"] { background:var(--alwayson-bg);  color:var(--alwayson-text);  border-color:var(--alwayson); }
.layer-toggle[data-layer="alwayson"] .dot { background:var(--alwayson); }
.layer-toggle[data-layer="paid"]     { background:var(--paid-bg);      color:var(--paid-text);      border-color:var(--paid); }
.layer-toggle[data-layer="paid"]     .dot { background:var(--paid); }
.layer-toggle[data-layer="holidays"] { background:var(--holidays-bg);  color:var(--holidays-text);  border-color:var(--holidays); }
.layer-toggle[data-layer="holidays"] .dot { background:var(--holidays); }
.layer-toggle.off { background:transparent!important; color:var(--text-muted)!important; border-color:var(--border)!important; }
.layer-toggle.off .dot { background:var(--text-light)!important; }

/* ‚îÄ‚îÄ Main area: calendar + slide panel ‚îÄ‚îÄ */
.main {
  flex:1; display:flex; overflow:hidden; position:relative;
}

/* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
.cal-wrap {
  flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0;
  transition: margin-right .25s ease;
}
.cal-header {
  display:grid; grid-template-columns:repeat(7,1fr);
  background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0;
}
.cal-header-day {
  padding:6px 8px; font-size:11px; font-weight:600; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.05em;
  border-right:1px solid var(--border);
}
.cal-header-day:last-child { border-right:none; }

.cal-grid {
  flex:1; display:grid; grid-template-columns:repeat(7,1fr);
  grid-auto-rows:auto; overflow-y:auto;
  align-content:start; position:relative;
}

.cal-cell {
  background:var(--surface); border-right:1px solid var(--border);
  border-bottom:1px solid var(--border); padding:4px 4px 28px;
  cursor:pointer; transition:background .1s;
  display:block; position:relative;
  min-height:90px;
}
.cal-cell:nth-child(7n) { border-right:none; }
.cal-cell:hover { background:var(--surface2); }
.day-add-btn {
  position:absolute; bottom:4px; right:4px;
  width:20px; height:20px; border-radius:50%;
  background:none; border:1.5px solid var(--border);
  color:var(--text-muted); font-size:16px; line-height:1;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  opacity:0; transition:opacity .12s, background .12s; padding:0; font-family:inherit;
}
.cal-cell:hover .day-add-btn { opacity:1; }
.day-add-btn:hover { background:var(--surface2); color:var(--text); border-color:var(--text-muted); }
.cal-cell.other-month { background:var(--bg); }
.cal-cell.other-month .day-num { color:var(--text-light); }
.day-num {
  font-size:12px; font-weight:500; color:var(--text-muted);
  width:22px; height:22px; border-radius:50%; display:flex;
  align-items:center; justify-content:center; flex-shrink:0; margin-bottom:2px;
}
.cal-cell.today .day-num { background:#7c3aed; color:#fff; font-weight:700; }

/* ‚îÄ‚îÄ Events ‚îÄ‚îÄ */
.event {
  display:block; border-radius:3px; padding:2px 5px; margin-bottom:2px;
  cursor:pointer; overflow:hidden; text-decoration:none; border-left:3px solid transparent;
  transition:filter .1s; flex-shrink:0;
}
.event:hover { filter:brightness(.93); }
.event-title {
  font-size:10.5px; font-weight:500; white-space:nowrap;
  overflow:hidden; text-overflow:ellipsis; line-height:1.4;
}
.event-pills { display:flex; gap:2px; flex-wrap:wrap; margin-top:2px; }
.pill {
  font-size:9px; font-weight:700; padding:1px 4px; border-radius:3px;
  white-space:nowrap; line-height:1.5; letter-spacing:.01em;
}
.pill-tiktok    { background:#010101; color:#fff; }
.pill-reel      { background:#e1306c; color:#fff; }
.pill-carousel  { background:#7c3aed; color:#fff; }
.pill-stories   { background:#fd7e14; color:#fff; }
.pill-image     { background:#405de6; color:#fff; }
.pill-fbpost    { background:#1877f2; color:#fff; }
.pill-edm       { background:#f59e0b; color:#111; }
.pill-blog      { background:#6b7280; color:#fff; }
.pill-metaads   { background:#0668E1; color:#fff; }
.pill-googleads { background:#34a853; color:#fff; }
.pill-generic   { background:#e5e7eb; color:#374151; }
.pill-tkt  { background:#010101; color:#fff; }
.pill-yt   { background:#ff0000; color:#fff; }
.pill-igfb { background:linear-gradient(135deg,#833ab4,#e1306c); color:#fff; }
.pill-igt  { background:#c13584; color:#fff; }
.pill-paidloc { background:#0668E1; color:#fff; }
.pill-web  { background:#10b981; color:#fff; }
.pill-email{ background:#6b7280; color:#fff; }
.pill-campaign { background:transparent; color:var(--text-muted); border:1px solid var(--border); font-style:italic; }

.event.campaigns { background:var(--campaigns-bg); border-left-color:var(--campaigns); }
.event.campaigns .event-title { color:var(--campaigns-text); }
.event.content   { background:var(--content-bg);   border-left-color:var(--content); }
.event.content   .event-title { color:var(--content-text); }
.event.alwayson  { background:var(--alwayson-bg);  border-left-color:var(--alwayson); }
.event.alwayson  .event-title { color:var(--alwayson-text); }
.event.paid      { background:var(--paid-bg);      border-left-color:var(--paid); }
.event.paid      .event-title { color:var(--paid-text); }
.event.holidays  { background:var(--holidays-bg);  border-left-color:var(--holidays); }
.event.holidays  .event-title { color:var(--holidays-text); }
/* Multi-day span: continuous bar look */
.event.span-start { border-radius:3px 0 0 3px; margin-right:-4px; padding-right:5px; }
.event.span-mid   { border-radius:0; border-left:none; margin-left:-4px; margin-right:-4px; padding-left:5px; }
.event.span-end   { border-radius:0 3px 3px 0; border-left:none; margin-left:-4px; padding-left:5px; }
.event.span-mid .event-title, .event.span-end .event-title { visibility:hidden; font-size:1px; }
.event.span-mid .event-pills, .event.span-end .event-pills { display:none; }
.event[data-layer].hidden { display:none!important; }

/* ‚îÄ‚îÄ Slide-in task panel ‚îÄ‚îÄ */
.task-panel {
  width: 420px; flex-shrink:0;
  background:var(--surface); border-left:1px solid var(--border);
  display:flex; flex-direction:column;
  transform:translateX(100%); transition:transform .25s ease;
  position:absolute; right:0; top:0; bottom:0; z-index:15;
  box-shadow:-4px 0 16px var(--shadow);
}
.task-panel.open { transform:translateX(0); }

.panel-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid var(--border); flex-shrink:0;
}
.panel-title { font-size:13px; font-weight:600; color:var(--text); flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.panel-actions { display:flex; gap:6px; flex-shrink:0; }
.panel-close { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; line-height:1; }
.panel-close:hover { background:var(--surface2); }

/* panel-iframe-wrap is now a flex column so panel-body can scroll inside it */
.panel-iframe-wrap { flex:1; overflow:hidden; display:flex; flex-direction:column; }
.panel-body { flex:1; overflow-y:auto; padding:16px; }
.panel-footer { padding:12px 14px; border-top:1px solid var(--border); flex-shrink:0; }

.panel-loading {
  display:flex; align-items:center; justify-content:center;
  height:100%; color:var(--text-muted); font-size:12px; flex-direction:column; gap:8px;
}
.panel-spinner {
  width:24px; height:24px; border:2px solid var(--border);
  border-top-color:#7c3aed; border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* ‚îÄ‚îÄ Task detail field rows ‚îÄ‚îÄ */
.pf-row { display:flex; flex-direction:column; margin-bottom:12px; }
.pf-label {
  font-size:10px; font-weight:600; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.05em; margin-bottom:3px;
}
.pf-val { font-size:13px; color:var(--text); line-height:1.5; }
.pf-val a { color:#7c3aed; text-decoration:none; }
.pf-val a:hover { text-decoration:underline; }
.pf-desc {
  font-size:12px; line-height:1.6; color:var(--text);
  background:var(--surface2); border-radius:4px;
  padding:10px; border:1px solid var(--border);
  white-space:pre-wrap; word-break:break-word;
}
.pf-edit {
  width:100%; background:var(--surface2); border:1px solid var(--border);
  border-radius:4px; padding:8px 10px; color:var(--text); font-family:inherit;
  font-size:12px; line-height:1.6; resize:vertical; transition:border-color .12s;
}
.pf-edit:focus { outline:none; border-color:#7c3aed; box-shadow:0 0 0 2px rgba(124,58,237,0.1); }
.pf-edit-input {
  width:100%; background:var(--surface2); border:1px solid var(--border);
  border-radius:4px; padding:4px 8px; color:var(--text); font-family:inherit;
  font-size:12px; transition:border-color .12s;
}
.pf-edit-input:focus { outline:none; border-color:#7c3aed; box-shadow:0 0 0 2px rgba(124,58,237,0.1); }
.pf-status {
  display:inline-flex; align-items:center;
  padding:3px 10px; border-radius:20px;
  font-size:11px; font-weight:600; text-transform:capitalize;
}
.pf-divider { border:none; border-top:1px solid var(--border); margin:14px 0; }

/* ‚îÄ‚îÄ Assignee chips ‚îÄ‚îÄ */
.assignee-chip {
  display:inline-flex; align-items:center; gap:5px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:20px; padding:2px 8px 2px 2px;
  margin:2px 2px 2px 0; font-size:11px; font-weight:500; color:var(--text);
}
.assignee-avatar { width:20px; height:20px; border-radius:50%; object-fit:cover; }
.assignee-initials {
  width:20px; height:20px; border-radius:50%;
  background:#7c3aed; color:#fff; font-size:9px; font-weight:700;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}

/* ‚îÄ‚îÄ Create task modal ‚îÄ‚îÄ */
.overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:100;
  display:flex; align-items:center; justify-content:center; padding:16px;
  opacity:0; pointer-events:none; transition:opacity .15s;
}
.overlay.open { opacity:1; pointer-events:all; }
.modal {
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  padding:20px; width:100%; max-width:400px;
  box-shadow:0 20px 60px rgba(0,0,0,0.15);
  transform:translateY(10px); transition:transform .15s;
}
.overlay.open .modal { transform:translateY(0); }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
.modal-title  { font-size:14px; font-weight:600; }
.modal-close-btn { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:18px; padding:2px 6px; border-radius:4px; line-height:1; }
.modal-close-btn:hover { background:var(--surface2); }
.field { margin-bottom:11px; }
.field label { display:block; font-size:11px; font-weight:500; color:var(--text-muted); margin-bottom:4px; text-transform:uppercase; letter-spacing:.04em; }
.field input, .field select {
  width:100%; padding:7px 10px; border:1px solid var(--border); border-radius:var(--radius);
  background:var(--surface); color:var(--text); font-size:13px; font-family:inherit; outline:none;
}
.field input:focus, .field select:focus { border-color:#7c3aed; box-shadow:0 0 0 2px rgba(124,58,237,0.12); }
.field-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:14px; padding-top:14px; border-top:1px solid var(--border); }

/* ‚îÄ‚îÄ Status dropdown ‚îÄ‚îÄ */
.status-drop {
  position:absolute; top:calc(100% + 4px); left:0; z-index:200;
  background:var(--surface); border:1px solid var(--border);
  border-radius:6px; padding:4px; min-width:160px;
  box-shadow:0 8px 24px var(--shadow);
  display:none; flex-direction:column; gap:2px;
}
.status-drop.open { display:flex; }
.status-drop-item {
  border:none; cursor:pointer; padding:5px 10px; border-radius:4px;
  font-size:11px; font-weight:600; font-family:inherit;
  text-align:left; text-transform:capitalize; transition:filter .1s;
}
.status-drop-item:hover { filter:brightness(1.1); }

/* ‚îÄ‚îÄ Hover tooltip ‚îÄ‚îÄ */
#calTooltip {
  position:fixed; z-index:500; pointer-events:none;
  background:var(--surface); border:1px solid var(--border);
  border-radius:6px; padding:8px 10px;
  box-shadow:0 4px 20px var(--shadow);
  max-width:240px; min-width:120px; display:none;
}
#calTooltip.visible { display:block; }
.tt-title { font-size:12px; font-weight:600; color:var(--text); margin-bottom:5px; line-height:1.35; word-break:break-word; }
.tt-row { font-size:11px; color:var(--text-muted); margin-bottom:2px; line-height:1.4; }
.tt-pills { display:flex; gap:3px; flex-wrap:wrap; margin-top:5px; }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-left">
    <button class="btn btn-icon" id="prevBtn">&#8249;</button>
    <button class="btn" onclick="goToday()">Today</button>
    <button class="btn btn-icon" id="nextBtn">&#8250;</button>
    <span class="month-label" id="monthLabel"></span>
    <span class="status-dot" id="statusDot" title="Data status"></span>
    <button class="btn" onclick="loadTasks()" style="font-size:11px;padding:3px 8px">‚Üª</button>
    <button class="btn btn-icon" id="themeBtn" title="Toggle theme">‚òæ</button>
  </div>
  <div class="topbar-sep"></div>
  <div class="layers">
    <span class="layers-label">Lists</span>
    <button class="layer-toggle" data-layer="campaigns"><span class="dot"></span>Campaigns</button>
    <button class="layer-toggle" data-layer="content"><span class="dot"></span>Content</button>
    <button class="layer-toggle" data-layer="alwayson"><span class="dot"></span>Always On</button>
    <button class="layer-toggle" data-layer="paid"><span class="dot"></span>Paid Ads</button>
    <button class="layer-toggle" data-layer="holidays"><span class="dot"></span>Holidays</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="cal-wrap" id="calWrap">
    <div class="cal-header">
      <div class="cal-header-day">Mon</div><div class="cal-header-day">Tue</div>
      <div class="cal-header-day">Wed</div><div class="cal-header-day">Thu</div>
      <div class="cal-header-day">Fri</div><div class="cal-header-day">Sat</div>
      <div class="cal-header-day">Sun</div>
    </div>
    <div class="cal-grid" id="calGrid"></div>
  </div>

  <!-- Slide-in task panel -->
  <div class="task-panel" id="taskPanel">
    <div class="panel-header">
      <span class="panel-title" id="panelTitle">Task</span>
      <div class="panel-actions">
        <button class="btn btn-icon" id="panelOpenBtn" onclick="openTaskUrl()" title="Open in ClickUp" style="font-size:11px">‚Üó Open</button>
        <button class="panel-close" onclick="closePanel()">√ó</button>
      </div>
    </div>
    <div class="panel-iframe-wrap" id="panelContent">
      <div class="panel-loading">
        <div class="panel-spinner"></div>
        <span>Loading task‚Ä¶</span>
      </div>
    </div>
  </div>
</div>

<!-- Hover tooltip -->
<div id="calTooltip"></div>

<!-- Create task modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">New Task</span>
      <button class="modal-close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="field">
      <label>Title</label>
      <input type="text" id="f-title" placeholder="Task name‚Ä¶" />
    </div>
    <div class="field">
      <label>List</label>
      <select id="f-layer">
        <option value="content">Campaign Content</option>
        <option value="campaigns">Campaigns</option>
        <option value="alwayson">Always On</option>
        <option value="paid">Paid Ads</option>
        <option value="holidays">Holidays &amp; Events</option>
      </select>
    </div>
    <div class="field-row">
      <div class="field">
        <label>Content Type <span style="color:#ef4444">*</span></label>
        <select id="f-type" required>
          <option value="">‚Äî select ‚Äî</option>
          <option value="0">Selling Season</option>
          <option value="1">Always On</option>
          <option value="2">Campaign</option>
          <option value="3">TikTok</option>
          <option value="4">Reel</option>
          <option value="5">Carousel</option>
          <option value="6">Image</option>
          <option value="7">Stories</option>
          <option value="8">FB Post</option>
          <option value="9">EDM</option>
          <option value="10">Blog</option>
          <option value="11">Pop Up</option>
          <option value="12">Web Banner</option>
        </select>
      </div>
      <div class="field">
        <label>Hemisphere <span style="color:#ef4444">*</span></label>
        <select id="f-hemisphere" required>
          <option value="">‚Äî select ‚Äî</option>
          <option value="0">Both</option>
          <option value="1">Southern</option>
          <option value="2">Northern</option>
        </select>
      </div>
    </div>
    <div class="field-row">
      <div class="field"><label>Start Date</label><input type="date" id="f-start" /></div>
      <div class="field"><label>End Date</label><input type="date" id="f-end" /></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="createBtn" onclick="createTask()">Create Task</button>
    </div>
  </div>
</div>

<script>
const API = "/api/clickup";
let tasks = [];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
const layerVis = { campaigns:true, content:true, alwayson:true, paid:true, holidays:true };

// ‚îÄ‚îÄ Theme ‚îÄ‚îÄ
let forceDark = false;
const themeBtn = document.getElementById("themeBtn");
function isDark() { return forceDark !== null ? forceDark : window.matchMedia("(prefers-color-scheme:dark)").matches; }
function applyTheme() {
  isDark() ? document.documentElement.setAttribute("data-dark","") : document.documentElement.removeAttribute("data-dark");
  themeBtn.textContent = isDark() ? "‚òÄÔ∏é" : "‚òæ";
}
themeBtn.addEventListener("click", () => { forceDark = !isDark(); applyTheme(); });
window.matchMedia("(prefers-color-scheme:dark)").addEventListener("change", () => { if(forceDark===null) applyTheme(); });
applyTheme();

// ‚îÄ‚îÄ Pill helpers ‚îÄ‚îÄ
function typePillClass(t) {
  const m = { TikTok:"pill-tiktok", Reel:"pill-reel", Carousel:"pill-carousel",
    Stories:"pill-stories", Image:"pill-image", "FB Post":"pill-fbpost",
    EDM:"pill-edm", Blog:"pill-blog", "Meta Ads":"pill-metaads", "Google Ads":"pill-googleads" };
  return m[t] || "pill-generic";
}
function locPillClass(l) {
  const m = { TikTok:"pill-tkt", YouTube:"pill-yt", "IG/FB":"pill-igfb",
    "IG Trial":"pill-igt", "Paid Ad":"pill-paidloc", Website:"pill-web", Email:"pill-email" };
  return m[l] || "pill-generic";
}

// ‚îÄ‚îÄ Scroll to current week ‚îÄ‚îÄ
function scrollToCurrentWeek() {
  const grid = document.getElementById("calGrid");
  const now = new Date();
  if(now.getFullYear() !== currentYear || now.getMonth() !== currentMonth) return;
  // Use the actual offsetTop of today's cell (works with variable row heights)
  requestAnimationFrame(() => {
    const todayCell = grid.querySelector(".cal-cell.today");
    if(todayCell) grid.scrollTop = todayCell.offsetTop;
  });
}

// ‚îÄ‚îÄ Load tasks ‚îÄ‚îÄ
async function loadTasks() {
  const dot = document.getElementById("statusDot");
  dot.className = "status-dot loading";
  try {
    const res = await fetch(`${API}?action=tasks`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    tasks = await res.json();
    dot.className = "status-dot";
    dot.title = `Refreshed ${new Date().toLocaleTimeString("en-AU")}`;
    render();
    scrollToCurrentWeek();
  } catch(e) {
    dot.className = "status-dot error";
    dot.title = "Error: " + e.message;
    console.error(e);
  }
}

// ‚îÄ‚îÄ Date helpers ‚îÄ‚îÄ
function parseDate(s) { if(!s) return null; const [y,m,d]=s.split("-").map(Number); return new Date(y,m-1,d); }
function isSameDay(a,b) { return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate(); }
function fmtDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

// ‚îÄ‚îÄ Task detail helpers ‚îÄ‚îÄ
function escapeHtml(s) {
  return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function fmtDisp(iso) {
  if(!iso) return "‚Äî";
  const [y,mo,d] = iso.split("-").map(Number);
  return new Date(y, mo-1, d).toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"});
}

function contrastColor(hex) {
  if(!hex) return "#1f2937";
  let h = hex.replace("#","");
  if(h.length === 3) h = h.split("").map(c => c+c).join("");
  if(h.length < 6) return "#1f2937";
  const r=parseInt(h.slice(0,2),16)||0, g=parseInt(h.slice(2,4),16)||0, b=parseInt(h.slice(4,6),16)||0;
  return (r*299 + g*587 + b*114) / 1000 > 140 ? "#111" : "#fff";
}

// ‚îÄ‚îÄ Hover tooltip ‚îÄ‚îÄ
const _tt = document.getElementById("calTooltip");
function _showTip(e, t) {
  const typeName = t.type?.name || (typeof t.type === "string" ? t.type : "");
  const locs = (t.locations||[]).map(l => l?.name||(typeof l==="string"?l:"")).filter(Boolean);
  let h = `<div class="tt-title">${escapeHtml(t.title)}</div>`;
  if(t.status) h += `<div class="tt-row">‚óè ${escapeHtml(t.status)}</div>`;
  if(t.start) {
    const dateStr = t.end && t.end !== t.start ? `${fmtDisp(t.start)} ‚Üí ${fmtDisp(t.end)}` : fmtDisp(t.start);
    h += `<div class="tt-row">üìÖ ${dateStr}</div>`;
  }
  if(typeName || locs.length) {
    h += `<div class="tt-pills">`;
    if(typeName) h += `<span class="pill ${typePillClass(typeName)}">${escapeHtml(typeName)}</span>`;
    locs.forEach(l => h += `<span class="pill ${locPillClass(l)}">${escapeHtml(l)}</span>`);
    h += `</div>`;
  }
  if(t.campaign) h += `<div class="tt-row" style="margin-top:3px;font-style:italic">‚Ü© ${escapeHtml(t.campaign)}</div>`;
  _tt.innerHTML = h;
  _tt.classList.add("visible");
  _moveTip(e);
}
function _moveTip(e) {
  const x = e.clientX + 14, y = e.clientY + 14;
  _tt.style.left = (x + 250 > window.innerWidth ? e.clientX - 260 : x) + "px";
  _tt.style.top  = (y + 160 > window.innerHeight ? e.clientY - 170 : y) + "px";
}
function _hideTip() { _tt.classList.remove("visible"); }

function formatFieldValue(field) {
  const { type, value, type_config } = field;
  if(value === null || value === undefined || value === "") return null;
  switch(type) {
    case "drop_down": {
      const opts = type_config?.options || [];
      const opt = opts.find(o => o.orderindex === value || o.id === value);
      if(!opt) return escapeHtml(value);
      const color = (opt.color && opt.color !== "none") ? opt.color : null;
      const bg = color || "var(--surface2)";
      const fg = color ? contrastColor(color) : "var(--text)";
      const border = color ? "" : ";border:1px solid var(--border)";
      return `<span style="display:inline-block;background:${bg};color:${fg};border-radius:4px;padding:2px 8px;font-size:11px;font-weight:600${border}">${escapeHtml(opt.name)}</span>`;
    }
    case "labels": {
      const vals = Array.isArray(value) ? value : [value];
      const opts = type_config?.options || [];
      return vals.map(v => {
        const id = typeof v === "string" ? v : v?.id;
        const opt = opts.find(o => o.id === id);
        const label = opt?.label || opt?.name || String(id);
        const rawColor = opt?.color || (typeof v === "object" ? v?.color : null);
        const color = (rawColor && rawColor !== "none") ? rawColor : null;
        const bg = color || "var(--surface2)";
        const fg = color ? contrastColor(color) : "var(--text)";
        const border = color ? "" : ";border:1px solid var(--border)";
        return `<span style="display:inline-block;background:${bg};color:${fg};border-radius:4px;padding:2px 8px;font-size:11px;font-weight:600;margin:1px${border}">${escapeHtml(label)}</span>`;
      }).join(" ");
    }
    case "date": {
      if(!value) return null;
      const iso = new Date(Number(value)).toISOString().split("T")[0];
      return fmtDisp(iso);
    }
    case "checkbox":
      return value ? "‚úì Yes" : "‚úó No";
    case "url":
      return `<a href="${escapeHtml(value)}" target="_blank" rel="noopener">${escapeHtml(value)}</a>`;
    case "email":
      return `<a href="mailto:${escapeHtml(value)}">${escapeHtml(value)}</a>`;
    case "phone":
      return `<a href="tel:${escapeHtml(value)}">${escapeHtml(value)}</a>`;
    case "number":
    case "currency":
    case "emoji":
    case "rating":
      return escapeHtml(String(value));
    case "short_text":
    case "text":
      return `<span style="white-space:pre-wrap">${escapeHtml(value)}</span>`;
    case "users": {
      const arr = Array.isArray(value) ? value : [value];
      return arr.map(u => {
        const name = u.username || u.name || u.email || "?";
        const initials = name.split(" ").map(p => p[0]||"").join("").slice(0,2).toUpperCase();
        const avatar = u.profilePicture || u.profile_picture || u.avatar || "";
        const avatarHtml = avatar
          ? `<img class="assignee-avatar" src="${escapeHtml(avatar)}" alt="">`
          : `<span class="assignee-initials">${escapeHtml(initials)}</span>`;
        return `<span class="assignee-chip">${avatarHtml}${escapeHtml(name)}</span>`;
      }).join(" ");
    }
    default:
      return null;
  }
}

// ‚îÄ‚îÄ Panel state ‚îÄ‚îÄ
let _panelDetail = null;
let _panelUrl    = null;

// Navigate to the task within the current ClickUp webview window.
// Navigate to ClickUp task. Calendar is embedded as an iframe inside ClickUp's
// desktop app ‚Äî navigating window.parent takes ClickUp itself to the task URL,
// opening the native task view. Falls back to current window if not in an iframe.
function openTaskUrl() {
  const url = _panelDetail?.url || _panelUrl;
  if(!url) return;
  const target = (window.parent !== window) ? window.parent : window;
  target.location.href = url;
}

function openStatusDrop(e) {
  e.stopPropagation();
  const menu = document.getElementById("statusDropMenu");
  if(menu) menu.classList.toggle("open");
}
document.addEventListener("click", () => {
  const menu = document.getElementById("statusDropMenu");
  if(menu) menu.classList.remove("open");
});
async function applyStatus(newStatus) {
  const menu = document.getElementById("statusDropMenu");
  if(menu) menu.classList.remove("open");
  if(!_panelDetail) return;
  try {
    await fetch(`${API}?action=update`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ id: _panelDetail.id, status: newStatus }),
    });
    const res = await fetch(`${API}?action=task&id=${_panelDetail.id}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    renderTaskDetail(await res.json());
    const t = tasks.find(t => t.id === _panelDetail.id);
    if(t) t.status = newStatus;
  } catch(e) {
    console.error("Status update failed:", e);
  }
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function render() {
  const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
  document.getElementById("monthLabel").textContent = `${months[currentMonth]} ${currentYear}`;
  const grid = document.getElementById("calGrid");
  grid.innerHTML = "";
  const today = new Date();
  const firstDay = new Date(currentYear, currentMonth, 1);
  const startOffset = (firstDay.getDay()+6)%7;
  const daysInMonth = new Date(currentYear,currentMonth+1,0).getDate();
  const prevDays = new Date(currentYear,currentMonth,0).getDate();

  const cells = [];
  for(let i=startOffset-1;i>=0;i--) cells.push({date:new Date(currentYear,currentMonth-1,prevDays-i),other:true});
  for(let d=1;d<=daysInMonth;d++) cells.push({date:new Date(currentYear,currentMonth,d),other:false});
  const rem=(7-(cells.length%7))%7;
  for(let d=1;d<=rem;d++) cells.push({date:new Date(currentYear,currentMonth+1,d),other:true});

  cells.forEach(cell => {
    const div = document.createElement("div");
    div.className = "cal-cell"+(cell.other?" other-month":"")+(isSameDay(cell.date,today)?" today":"");

    const numDiv = document.createElement("div");
    numDiv.className = "day-num";
    numDiv.textContent = cell.date.getDate();
    div.appendChild(numDiv);

    const addBtn = document.createElement("button");
    addBtn.className = "day-add-btn";
    addBtn.textContent = "+";
    addBtn.title = "New task";
    addBtn.addEventListener("click", e => { e.stopPropagation(); openModal(cell.date); });
    div.appendChild(addBtn);

    const dayTasks = tasks.filter(t => {
      const s = parseDate(t.start), e = parseDate(t.end) || parseDate(t.start);
      if(!s&&!e) return false;
      return cell.date >= (s||e) && cell.date <= (e||s);
    });

    dayTasks.forEach(t => {
      const s = parseDate(t.start), e = parseDate(t.end) || parseDate(t.start);
      const isStart = isSameDay(cell.date, s||e);
      const isEnd   = isSameDay(cell.date, e||s);
      const isSpan  = s && e && !isSameDay(s,e);
      let spanClass = "";
      if(isSpan) { spanClass = isStart ? "span-start" : isEnd ? "span-end" : "span-mid"; }

      const evDiv = document.createElement("div");
      evDiv.className = `event ${t.layer} ${spanClass}`;
      evDiv.setAttribute("data-layer", t.layer);
      if(!layerVis[t.layer]) evDiv.classList.add("hidden");

      evDiv.addEventListener("click", e => { e.stopPropagation(); openPanel(t); });
      evDiv.addEventListener("mouseenter", e => _showTip(e, t));
      evDiv.addEventListener("mousemove", _moveTip);
      evDiv.addEventListener("mouseleave", _hideTip);

      if(!isSpan || isStart) {
        const titleDiv = document.createElement("div");
        titleDiv.className = "event-title";
        titleDiv.textContent = t.title;
        evDiv.appendChild(titleDiv);

        // Only show pills on single-day events ‚Äî keeps bar height uniform on multi-day spans
        const typeName = t.type?.name || (typeof t.type === "string" ? t.type : "");
        const skipTypes = new Set(["Campaign","Always On","Selling Season"]);
        const showType = typeName && !skipTypes.has(typeName);
        if(!isSpan && (showType || (t.locations && t.locations.length))) {
          const pillsDiv = document.createElement("div");
          pillsDiv.className = "event-pills";
          if(showType) {
            const p = document.createElement("span");
            const typeColor = t.type?.color;
            if(typeColor) {
              p.className = "pill";
              p.style.background = typeColor;
              p.style.color = contrastColor(typeColor);
            } else {
              p.className = `pill ${typePillClass(typeName)}`;
            }
            p.textContent = typeName;
            pillsDiv.appendChild(p);
          }
          (t.locations||[]).forEach(loc => {
            const locName = loc?.name || (typeof loc === "string" ? loc : "");
            if(!locName) return;
            const locColor = loc?.color;
            const p = document.createElement("span");
            if(locColor) {
              p.className = "pill";
              p.style.background = locColor;
              p.style.color = contrastColor(locColor);
            } else {
              p.className = `pill ${locPillClass(locName)}`;
            }
            p.textContent = locName;
            pillsDiv.appendChild(p);
          });
          if(t.campaign) {
            const p = document.createElement("span");
            p.className = "pill pill-campaign";
            p.textContent = t.campaign;
            pillsDiv.appendChild(p);
          }
          if(pillsDiv.children.length) evDiv.appendChild(pillsDiv);
        }
      } else {
        evDiv.innerHTML = "&nbsp;";
      }

      div.appendChild(evDiv);
    });

    grid.appendChild(div);
  });
}

// ‚îÄ‚îÄ Slide panel ‚îÄ‚îÄ
async function openPanel(task) {
  _hideTip();
  const panel = document.getElementById("taskPanel");
  const content = document.getElementById("panelContent");
  const titleEl = document.getElementById("panelTitle");

  titleEl.textContent = task.title;
  _panelUrl = task.url || null;
  content.innerHTML = `<div class="panel-loading"><div class="panel-spinner"></div><span>Loading‚Ä¶</span></div>`;
  panel.classList.add("open");

  try {
    const res = await fetch(`${API}?action=task&id=${task.id}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const detail = await res.json();
    renderTaskDetail(detail);
  } catch(e) {
    console.warn("Task detail fetch failed, showing summary:", e);
    renderTaskBasic(task);
  }
}

function renderTaskDetail(detail) {
  _panelDetail = detail;
  const content = document.getElementById("panelContent");
  document.getElementById("panelTitle").textContent = detail.name || "Task";

  // Interactive status dropdown
  const sc = detail.statusColor || "#6b7280";
  const sf = contrastColor(sc);
  const statusItems = (detail.statuses || []).map(s => {
    const bg = (s.color && s.color !== "none") ? s.color : "#6b7280";
    const fg = contrastColor(bg);
    return `<button class="status-drop-item" style="background:${bg};color:${fg}" onclick="applyStatus(${JSON.stringify(s.status)})">${escapeHtml(s.status)}</button>`;
  }).join("");
  const statusBadge = `<div style="position:relative;display:inline-block">
    <button class="pf-status" style="background:${sc};color:${sf};border:none;cursor:pointer;gap:4px" onclick="openStatusDrop(event)">${escapeHtml(detail.status||"‚Äî")}<span style="opacity:.7;font-size:9px">‚ñæ</span></button>
    <div class="status-drop" id="statusDropMenu">${statusItems}</div>
  </div>`;

  // Assignee chips
  let assigneeHtml = "‚Äî";
  if(detail.assignees && detail.assignees.length) {
    assigneeHtml = detail.assignees.map(a => {
      const name = a.name || "?";
      const initials = name.split(" ").map(p => p[0]||"").join("").slice(0,2).toUpperCase();
      const avatarHtml = a.avatar
        ? `<img class="assignee-avatar" src="${escapeHtml(a.avatar)}" alt="">`
        : `<span class="assignee-initials">${escapeHtml(initials)}</span>`;
      return `<span class="assignee-chip">${avatarHtml}${escapeHtml(name)}</span>`;
    }).join("");
  }

  // Custom fields ‚Äî skip structural types and date fields shown in fixed rows
  const SKIP_TYPES = new Set(["list_relationship","tasks_rollup","formula","auto_progress","rollup"]);
  const SKIP_NAMES = new Set(["Publish Date","End date"]);
  let fieldsHtml = "";
  (detail.customFields || []).forEach(f => {
    if(SKIP_TYPES.has(f.type) || SKIP_NAMES.has(f.name)) return;
    const rendered = formatFieldValue(f);
    if(!rendered) return;
    fieldsHtml += `<div class="pf-row"><div class="pf-label">${escapeHtml(f.name)}</div><div class="pf-val">${rendered}</div></div>`;
  });

  // Publish date from custom fields
  const pubField = (detail.customFields||[]).find(f => f.name === "Publish Date");
  const pubIso = pubField?.value ? new Date(Number(pubField.value)).toISOString().split("T")[0] : null;

  content.innerHTML = `
    <div class="panel-body">
      <div class="pf-row" style="margin-bottom:14px;flex-direction:row;align-items:center;gap:8px;flex-wrap:wrap">
        ${statusBadge}
        <span style="font-size:11px;color:var(--text-muted)">${escapeHtml(detail.listName||"")}</span>
      </div>
      <div class="pf-row">
        <div class="pf-label">Title</div>
        <input class="pf-edit-input" id="edit-title" value="${escapeHtml(detail.name||"")}" />
      </div>
      <div class="pf-row">
        <div class="pf-label">Description</div>
        <textarea class="pf-edit" id="edit-desc" rows="4">${escapeHtml(detail.description||"")}</textarea>
      </div>
      <div class="pf-row">
        <div class="pf-label">Assignees</div>
        <div class="pf-val">${assigneeHtml}</div>
      </div>
      <div class="pf-row">
        <div class="pf-label">Publish Date</div>
        <div class="pf-val">${fmtDisp(pubIso)}</div>
      </div>
      <div class="pf-row">
        <div class="pf-label">Start Date</div>
        <input class="pf-edit-input" type="date" id="edit-start" value="${detail.startDate||""}" />
      </div>
      <div class="pf-row">
        <div class="pf-label">End Date</div>
        <input class="pf-edit-input" type="date" id="edit-end" value="${detail.dueDate||""}" />
      </div>
      ${fieldsHtml ? `<hr class="pf-divider">${fieldsHtml}` : ""}
    </div>
    <div class="panel-footer">
      <button class="btn btn-primary" id="saveTaskBtn" onclick="saveTaskEdits()">Save Changes</button>
    </div>`;
}

async function saveTaskEdits() {
  if(!_panelDetail) return;
  const btn = document.getElementById("saveTaskBtn");
  if(btn) { btn.textContent = "Saving‚Ä¶"; btn.disabled = true; }
  try {
    const title = document.getElementById("edit-title")?.value.trim();
    const desc  = document.getElementById("edit-desc")?.value;
    const start = document.getElementById("edit-start")?.value;
    const end   = document.getElementById("edit-end")?.value;
    const res = await fetch(`${API}?action=update`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        id:          _panelDetail.id,
        name:        title || undefined,
        description: desc,
        startDate:   start || null,
        dueDate:     end   || null,
      }),
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    // Show Saved! confirmation before re-rendering
    const b = document.getElementById("saveTaskBtn");
    if(b) { b.textContent = "‚úì Saved!"; b.style.background = "#059669"; b.disabled = false; }
    // Update cached task title immediately so calendar reflects change
    const t = tasks.find(t => t.id === _panelDetail.id);
    if(t && title) { t.title = title; render(); }
    // After brief pause, reload fresh data from server (restores button via re-render)
    await new Promise(r => setTimeout(r, 1500));
    const r2 = await fetch(`${API}?action=task&id=${_panelDetail.id}`);
    if(r2.ok) renderTaskDetail(await r2.json());
  } catch(e) {
    alert("Save failed: " + e.message);
    const b = document.getElementById("saveTaskBtn");
    if(b) { b.textContent = "Save Changes"; b.style.background = ""; b.disabled = false; }
  }
}

function renderTaskBasic(task) {
  const content = document.getElementById("panelContent");
  content.innerHTML = `
    <div class="panel-body">
      <div class="pf-row">
        <div class="pf-label">Status</div>
        <div class="pf-val"><span class="pf-status" style="background:var(--surface2);color:var(--text)">${escapeHtml(task.status||"‚Äî")}</span></div>
      </div>
      <div class="pf-row">
        <div class="pf-label">List</div>
        <div class="pf-val">${escapeHtml(task.layer)}</div>
      </div>
      ${task.type ? `<div class="pf-row"><div class="pf-label">Content Type</div><div class="pf-val">${escapeHtml(task.type?.name||task.type)}</div></div>` : ""}
      ${task.locations && task.locations.length ? `<div class="pf-row"><div class="pf-label">Publish Locations</div><div class="pf-val">${task.locations.map(loc=>{const n=loc?.name||(typeof loc==="string"?loc:"");const c=loc?.color;return c?`<span class="pill" style="background:${c};color:${contrastColor(c)}">${escapeHtml(n)}</span>`:`<span class="pill ${locPillClass(n)}">${escapeHtml(n)}</span>`;}).join(" ")}</div></div>` : ""}
      <div class="pf-row">
        <div class="pf-label">Publish Date</div>
        <div class="pf-val">${fmtDisp(task.publishDate)}</div>
      </div>
      <div class="pf-row">
        <div class="pf-label">Campaign Dates</div>
        <div class="pf-val">${fmtDisp(task.start)} ‚Üí ${fmtDisp(task.end)}</div>
      </div>
      ${task.assignees && task.assignees.length ? `<div class="pf-row"><div class="pf-label">Assignees</div><div class="pf-val">${task.assignees.map(a => {
        const name = a.name || "?";
        const initials = name.split(" ").map(p=>p[0]||"").join("").slice(0,2).toUpperCase();
        return `<span class="assignee-chip"><span class="assignee-initials">${escapeHtml(initials)}</span>${escapeHtml(name)}</span>`;
      }).join("")}</div></div>` : ""}
    </div>`;
}

function closePanel() {
  document.getElementById("taskPanel").classList.remove("open");
}

// Close panel on Escape
document.addEventListener("keydown", e => {
  if(e.key === "Escape") { closeModal(); closePanel(); }
});

// ‚îÄ‚îÄ Create task modal ‚îÄ‚îÄ
function openModal(date) {
  const d = fmtDate(date);
  document.getElementById("f-start").value = d;
  document.getElementById("f-end").value = d;
  document.getElementById("f-title").value = "";
  document.getElementById("f-type").value = "";
  document.getElementById("f-hemisphere").value = "";
  document.getElementById("overlay").classList.add("open");
  setTimeout(() => document.getElementById("f-title").focus(), 120);
}
function closeModal() { document.getElementById("overlay").classList.remove("open"); }
document.getElementById("overlay").addEventListener("click", e => { if(e.target.id==="overlay") closeModal(); });

async function createTask() {
  const title = document.getElementById("f-title").value.trim();
  if(!title) { document.getElementById("f-title").focus(); return; }
  const contentType = document.getElementById("f-type").value;
  if(!contentType) { document.getElementById("f-type").focus(); return; }
  const hemisphere = document.getElementById("f-hemisphere").value;
  if(!hemisphere) { document.getElementById("f-hemisphere").focus(); return; }
  const btn = document.getElementById("createBtn");
  btn.textContent = "Creating‚Ä¶"; btn.disabled = true;
  try {
    const res = await fetch(`${API}?action=create`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        title,
        layer:       document.getElementById("f-layer").value,
        start:       document.getElementById("f-start").value,
        end:         document.getElementById("f-end").value,
        contentType,
        hemisphere,
      })
    });
    const data = await res.json();
    closeModal();
    await loadTasks();
    if(data.url) {
      const newTask = tasks.find(t => t.id === data.id) || { id:data.id, title, url:data.url, layer:document.getElementById("f-layer").value };
      openPanel(newTask);
    }
  } catch(e) {
    alert("Error creating task: " + e.message);
  } finally {
    btn.textContent = "Create Task"; btn.disabled = false;
  }
}

// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ
function resetScroll() { requestAnimationFrame(() => { document.getElementById("calGrid").scrollTop = 0; }); }
document.getElementById("prevBtn").addEventListener("click", () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} render(); resetScroll(); });
document.getElementById("nextBtn").addEventListener("click", () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} render(); resetScroll(); });
function goToday() { const n=new Date(); currentYear=n.getFullYear(); currentMonth=n.getMonth(); render(); scrollToCurrentWeek(); }

// ‚îÄ‚îÄ Layer toggles ‚îÄ‚îÄ
document.querySelectorAll(".layer-toggle").forEach(btn => {
  btn.addEventListener("click", () => {
    const l = btn.dataset.layer;
    layerVis[l] = !layerVis[l];
    btn.classList.toggle("off", !layerVis[l]);
    document.querySelectorAll(`.event[data-layer="${l}"]`).forEach(ev => ev.classList.toggle("hidden", !layerVis[l]));
  });
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadTasks();
setInterval(loadTasks, 10*60*1000);
</script>
</body>
</html>
